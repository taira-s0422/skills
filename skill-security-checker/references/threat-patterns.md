# 脅威パターン リファレンス

自動スキャナーでは検出困難な脅威パターン集。Claudeのセマンティック分析時に参照する。

---

## 1. 間接的データ窃取

正規の機能に見せかけて情報を外部に送信するパターン。

### 検出ポイント
- **ログ送信の偽装**: 「エラーログを送信」「使用状況をレポート」と称して機密データを含める
- **アナリティクス偽装**: テレメトリやバグレポートに環境変数・設定値を含める
- **DNS窃取**: DNSクエリのサブドメインにデータをエンコードして送信（`data.evil.com` のようなリクエスト）
- **画像URL窃取**: 画像URLにクエリパラメータとしてデータを埋め込む（`img.evil.com/pixel.png?d=...`）

### 確認すべき質問
- 外部通信の宛先は文書化されているか？
- 送信データに機密情報が含まれていないか？
- 通信先のドメインは信頼できるか？

---

## 2. 段階的権限昇格

一度に危険な操作を行わず、段階的に権限を拡大するパターン。

### 検出ポイント
- **設定ファイルの漸進的変更**: 最初は無害な設定変更 → 徐々にセキュリティ設定を緩める
- **一時ファイル経由の攻撃**: `/tmp` にスクリプトを書き出し、後の工程で実行
- **パーミッション変更の連鎖**: ファイル作成 → chmod → 実行権限付与 → 実行
- **環境変数の操作**: PATH や LD_PRELOAD の変更で正規コマンドを差し替え

### 確認すべき質問
- ファイル操作の全体フローに不自然な権限変更がないか？
- 一時ファイルを作成して後で実行するパターンがないか？
- 環境変数を変更する理由が明確か？

---

## 3. タイミング攻撃・条件付き実行

特定の条件下でのみ悪意ある動作を行うパターン。

### 検出ポイント
- **環境チェック**: `CI=true` / `NODE_ENV=production` で動作を分岐
- **日時トリガー**: 特定の日付・時刻にのみ実行されるコード
- **ネットワーク依存**: 特定のホスト名やIPアドレスでのみ動作
- **実行回数制限**: N回目の実行で初めて発動
- **ランダム発動**: `Math.random()` やタイムスタンプの偶奇で分岐

### 確認すべき質問
- 条件分岐の中に不自然なコードブロックがないか？
- 環境変数チェックの目的は明確か？
- ランダムや日時で動作が変わる理由があるか？

---

## 4. ソーシャルエンジニアリング

技術的な攻撃ではなく、ユーザーの判断を誘導するパターン。

### 検出ポイント
- **緊急性の演出**: 「今すぐ実行が必要」「期限切れになる前に」
- **権威の偽装**: 「公式推奨」「セキュリティパッチ」「必須アップデート」と称する操作
- **正常化**: 危険な操作を「通常の手順」として説明
- **偽のエラーメッセージ**: 存在しないエラーを表示し、修正と称して危険な操作を行わせる
- **過度な権限要求**: 機能に不要な権限（sudo, --force, bypassPermissions）の要求

### 確認すべき質問
- スキルの説明文に不自然な緊急性や権威づけがないか？
- 要求される権限はスキルの機能に見合っているか？
- エラーメッセージの内容は技術的に正しいか？

---

## 5. 依存関係の悪用

パッケージマネージャーの仕組みを利用した攻撃。

### 検出ポイント
- **タイポスクワッティング**: 有名パッケージの類似名（`reqeusts`, `colros`, `lodasg`）
- **バージョン固定なし**: `"*"` やバージョン指定なしのインストール
- **postinstall スクリプト**: npm/pip のインストール後フックで任意コード実行
- **プライベートレジストリ**: 不審なレジストリURLからのインストール
- **開発依存の混入**: devDependencies に本番で実行されるコードを隠す

### 確認すべき質問
- パッケージ名のスペルは正しいか？（公式リポジトリと照合）
- バージョン固定されているか？
- インストール後フックに不審なスクリプトがないか？

---

## 6. Claude / AI エージェント特有の脅威

AIエージェント環境を標的とした攻撃パターン。

### 検出ポイント
- **MCPサーバーの追加**: `.mcp.json` への不審なサーバー追加
- **CLAUDE.md の改ざん**: プロジェクト設定の書き換えで以降の全操作に影響
- **スキルチェーンの悪用**: 他のスキルを呼び出す際に意図しないパラメータを注入
- **コンテキスト汚染**: 長文のコメントやドキュメントでAIの判断を誘導
- **ツール結果の偽装**: ツールの出力に見せかけた偽の結果をAIに読ませる
- **権限モードの誘導**: `bypassPermissions` や `dontAsk` モードへの変更を促す

### 確認すべき質問
- スキルが `.claude/` ディレクトリ内のファイルを変更しようとしていないか？
- 他のスキルやツールを呼び出す際のパラメータは適切か？
- AI向けの指示文に不自然な誘導がないか？

---

## 7. ファイルシステム攻撃

ファイル操作を通じた攻撃パターン。

### 検出ポイント
- **シンボリックリンク攻撃**: 一時ファイルをシンボリックリンクに置き換え
- **レースコンディション**: ファイルの存在確認と操作の間のタイミング差を利用
- **大量ファイル作成**: ディスク枯渇攻撃
- **隠しファイル**: `.` で始まるファイルに悪意あるコードを配置
- **バイナリファイルの偽装**: テキストファイルの拡張子を持つバイナリ

### 確認すべき質問
- シンボリックリンクを作成・操作するコードがないか？
- ファイル操作にレースコンディションの可能性がないか？
- 隠しファイル（`.`始まり）の操作に正当な理由があるか？

---

## セマンティック分析チェックリスト

Claude がファイルを読んで分析する際の確認項目:

### 意図の一貫性
- [ ] スキルの説明（SKILL.md）と実際のコードの動作が一致しているか
- [ ] 不必要に広い範囲のファイルにアクセスしていないか
- [ ] 外部通信がスキルの目的に必要なものだけか

### 隠れた危険性
- [ ] コメントアウトされた危険なコードがないか
- [ ] 変数名や関数名で意図を偽装していないか（`updateConfig` で実際はデータ送信等）
- [ ] エラーハンドリングの中に不審なコードがないか

### 全体的な信頼性
- [ ] 作者・出所は明確か
- [ ] ライセンスが明記されているか
- [ ] READMEやドキュメントが十分に整備されているか
- [ ] コードの品質は妥当か（過度に複雑、過度に短い、は疑わしい）
